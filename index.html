<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloud29 AI System</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:48px 20px}
    .title{font-weight:800;font-size:34px;line-height:1.1;text-align:center;margin:0 0 10px}
    .subtitle{color:var(--muted);text-align:center;margin:0 0 26px}
    .chat-shell{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,.06);height:72vh;max-height:780px;display:flex;flex-direction:column;overflow:hidden}
    .chat-body{flex:1;overflow:auto;padding:18px 18px 10px;background:#fff}
    .row{display:flex;gap:10px;margin:10px 0;align-items:flex-start}
    .avatar{min-width:34px;height:34px;border-radius:999px;background:#eef2ff;color:#111827;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;border:1px solid var(--border)}
    .bubble{background:#f8fafc;border:1px solid var(--border);padding:12px 14px;border-radius:14px 14px 14px 6px;max-width:78%;white-space:pre-wrap}
    .row.user{justify-content:flex-end}
    .row.user .bubble{background:#dff1ff;border-color:#cae9ff;border-radius:14px 14px 6px 14px}
    .input-wrap{border-top:1px solid var(--border);background:#fff;padding:14px}
    .input{display:flex;gap:10px}
    .input input{flex:1;border:1px solid var(--border);border-radius:999px;padding:14px 16px;font-size:15px;outline:none}
    .input button{border:none;border-radius:999px;padding:0 18px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .cta{display:block;width:max-content;margin:18px auto 0;padding:10px 14px;border-radius:10px;border:1px solid var(--border);text-decoration:none;color:var(--text);background:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Cloud29 AI System</h1>
    <p class="subtitle">This takes around 2 minutes. Start by sharing your company name and a contact email.</p>

    <div class="chat-shell" id="chatShell" aria-live="polite">
      <div class="chat-body" id="chatBody"></div>
      <div class="input-wrap">
        <div class="input">
          <input id="chatInput" placeholder="Please type here..." />
          <button id="chatSend" aria-label="Send">âžœ</button>
        </div>
      </div>
    </div>

    <!-- Your booking button (uses your real link) -->
 <a class="cta" id="bookBtn" style="display:none" href="https://bookme.name/morgandeancloud29/discovery-call" target="_blank" rel="noopener">Book a demo</a>
  </div>

  <script>
    (function(){
      const body = document.getElementById('chatBody');
      const input = document.getElementById('chatInput');
      const send  = document.getElementById('chatSend');

      // conversation history (what we send to /api/chat)
      let history = [];

      // Initial assistant message (purely visual; conversation starts when user replies)
      pushAssistant(`Hi, thanks for speaking to the Cloud29 AI Assistant ðŸ‘‹. To begin, please share:
1) Your first name
2) Your company name
3) Your contact email (e.g., team@acme.com)`);

      send.onclick = submit;
      input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') submit(); });

      function row(el){ body.appendChild(el); body.scrollTop = body.scrollHeight; }
      function mk(tag, cls, txt){ const el=document.createElement(tag); if(cls) el.className=cls; if(txt!==undefined) el.textContent=txt; return el; }

      function pushAssistant(text){
        const r = mk('div','row');
        const a = mk('div','avatar','C29'); r.appendChild(a);
        const b = mk('div','bubble',text); r.appendChild(b);
        row(r);
        history.push({ role:'assistant', content:text });
      }

      function pushUser(text){
        const r = mk('div','row user');
        const b = mk('div','bubble',text); r.appendChild(b);
        row(r);
        history.push({ role:'user', content:text });
      }

      async function submit(){
        const text = input.value.trim();
        if(!text) return;
        input.value = '';
        pushUser(text);

        // placeholder assistant message to stream into
        const placeholder = { role:'assistant', content:'' };
        history.push(placeholder);

        const res = await fetch('/api/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ messages: history.filter(Boolean) })
        });

        if(!res.ok || !res.body){
          placeholder.content = 'Sorryâ€”something went wrong.';
          renderTail();
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        // render the placeholder row
        const r = mk('div','row'); const a = mk('div','avatar','C29'); r.appendChild(a);
        const b = mk('div','bubble',''); r.appendChild(b); row(r);

        while(true){
          const {value, done} = await reader.read();
          if(done) break;
          const chunk = decoder.decode(value, {stream:true});
          chunk.split('\n').forEach(line=>{
            if(!line.startsWith('data:')) return;
            const data = line.slice(5).trim();
            if(!data || data === '[DONE]') return;
            try{
              const json = JSON.parse(data);
              if(typeof json.delta === 'string'){
                placeholder.content += json.delta;
                b.textContent = placeholder.content;
                body.scrollTop = body.scrollHeight;

                // if final booking message appears, unhide the demo button
if (placeholder.content.includes("Please click the button below to book your demo call")) {
  document.getElementById('bookBtn').style.display = 'block';
}
              }
            }catch{}
          });
        }
      }

      function renderTail(){ /* no-op, bubbles already in DOM */ }
    })();
  </script>
</body>
</html>
